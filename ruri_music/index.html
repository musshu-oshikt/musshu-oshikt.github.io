<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>るりMusic</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        body{
            margin: 0px;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }
        #header{
            display: flex;
            height: 56px;
            background-color: #2887FF;
        }
        .header_left{
            width: 50%;
        }
        .header_right{
            width: 50%;
        }
        .header_title{
            padding:10px;
            color: #ffffff;
            font-weight: bold;
            font-size: 32px;
        }
        .main_contents {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
        .play_column{
            display:flex;
        }
        .img_middle{
            position: relative;
        /*    top: 10%; */
        }
        .play_info{
            max-width: 500px;
            width: 100%;
            overflow-x: hidden;
        }
        .play_info input{
            padding: 1px;
            outline: none;
            border: none;
        }
        #video-container {
            width: 100%;
            max-width: 1280px;
            aspect-ratio: 16 / 9;
            background: #ffffff;
            border-radius: 8px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #controls {
            width: 60%;
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-left: 20px;
        }
        input {
            width: 90%;
            padding: 10px;
/*            border: 1px solid #ccc;*/
            border-radius: 5px;
            font-size: 16px;
        }
        /*
        button {
            background-color: #007BFF;
            color: #ffffff;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        */
        /*
        #notes-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            background: #ffffff;
        }
        */
        #times{
            display: flex;
            gap: 5px;
        }
        #timedisplay{
            outline: none;
            border: none;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
/*            width: 100%;
            background: #e9ecef;*/
            padding-left: 10px;
            margin: 2px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow-x: hidden;
        }
        /*
        li input {
            width: 70%;
        }
        */
        span{
            white-space: nowrap;
        }
        .scroll_animation{
            animation: marquee 10s linear infinite;
        }
        .note-buttons {
            display: flex;
            gap: 5px;
        }
        .header_right{
            text-align: right;
        }
        #config{
            padding: 12px;
            width:40px;
            display: inline-block;
        }
        @media (max-width: 768px) {
            .main_contents {
                flex-direction: column;
                align-items: center;
            }
            #controls {
                width: 100%;
                margin-left: 0;
                margin-top: 20px;
            }
        }
        /*
        @keyframes marquee {
            from {
                transform: translate(0);
            }
            to {
                transform: translate(-100%);
            }
        }
        */
    </style>
</head>
<body>
<!-- header -->
<div id="header">
    <div class="header_left">
        <a class="header_title">るりMusic　～第二稿～</a>
    <!--
    気力があれば更新します。    
    -->
    </div>
    <div class="header_right">
        <div id="config">
            <style type="text/css">
                .st0{fill:#4B4B4B;}
            </style>
            <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="width: 32px; height: 32px; opacity: 1;" xml:space="preserve">
              <g>
                  <path class="st0" d="M499.453,210.004l-55.851-2.58c-5.102-0.23-9.608-3.395-11.546-8.103l-11.508-27.695
                  c-1.937-4.728-0.997-10.145,2.455-13.914l37.668-41.332c4.718-5.188,4.546-13.205-0.421-18.182l-46.434-46.443
        c-4.986-4.967-13.003-5.159-18.2-0.412l-41.312,37.668c-3.778,3.443-9.206,4.402-13.924,2.436l-27.694-11.488
        c-4.718-1.946-7.864-6.454-8.094-11.565l-2.589-55.831C301.675,5.534,295.883,0,288.864,0h-65.708
        c-7.02,0-12.831,5.534-13.156,12.562l-2.571,55.831c-0.23,5.111-3.376,9.618-8.094,11.565L171.64,91.447
        c-4.737,1.966-10.165,1.007-13.924-2.436l-41.331-37.668c-5.198-4.746-13.215-4.564-18.201,0.412L51.769,98.198
        c-4.986,4.977-5.158,12.994-0.422,18.182l37.668,41.332c3.452,3.769,4.373,9.186,2.416,13.914l-11.469,27.695
        c-1.956,4.708-6.444,7.873-11.564,8.103l-55.832,2.58c-7.019,0.316-12.562,6.118-12.562,13.147v65.699
        c0,7.019,5.543,12.83,12.562,13.148l55.832,2.579c5.12,0.229,9.608,3.394,11.564,8.103l11.469,27.694
        c1.957,4.728,1.036,10.146-2.416,13.914l-37.668,41.313c-4.756,5.217-4.564,13.224,0.403,18.201l46.471,46.443
        c4.967,4.977,12.965,5.15,18.182,0.422l41.312-37.677c3.759-3.443,9.207-4.392,13.924-2.435l27.694,11.478
        c4.719,1.956,7.864,6.464,8.094,11.575l2.571,55.831c0.325,7.02,6.136,12.562,13.156,12.562h65.708
        c7.02,0,12.812-5.542,13.138-12.562l2.589-55.831c0.23-5.111,3.376-9.619,8.094-11.575l27.694-11.478
        c4.718-1.957,10.146-1.008,13.924,2.435l41.312,37.677c5.198,4.728,13.215,4.555,18.2-0.422l46.434-46.443
        c4.967-4.977,5.139-12.984,0.421-18.201l-37.668-41.313c-3.452-3.768-4.412-9.186-2.455-13.914l11.508-27.694
        c1.937-4.709,6.444-7.874,11.546-8.103l55.851-2.579c7.019-0.318,12.542-6.129,12.542-13.148v-65.699
        C511.995,216.122,506.472,210.32,499.453,210.004z M256.01,339.618c-46.164,0-83.622-37.438-83.622-83.612
        c0-46.184,37.458-83.622,83.622-83.622s83.602,37.438,83.602,83.622C339.612,302.179,302.174,339.618,256.01,339.618z" style="fill: rgb(201, 201, 201);"></path>
              </g>
            </svg>
        </div>
    </div>
</div>
<!-- main contents -->
    <div class="main_contents">
      <div id="video-container">
          <div id="player"></div>
      </div>
      <div id="controls">
        <table id="playlist-table" class="display playlist-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>タイトル</th>
                    <th>プレイリスト</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
        let player;
        let videoList;
        let currentIndex = 0;
        let pattern = 0;
        let playerReady = false;
        let inputForcus = false;
        let videoIdList = [];
        let notes = [];
        
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '360',
                width: '640',
                videoId: 'ZeFvqdvutb4',
                events: { onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange
                 }
            });
        }
        
        function onPlayerReady(event) {
            videoList = $('#playlist-table').DataTable();
            // テーブルにある動画をリストに格納
            $('#playlist-table tbody tr').each(function() {
                videoIdList.push($(this).attr('id'));
            });
        

// クリックして再生
           $('#playlist-table tbody').on('click', 'tr', function () {
               alert('click');
                currentIndex = videoList.row(this).index();
                playVideoAtTime(videoIdList,currentIndex);
            });

            playerReady = true;
            document.addEventListener('keydown', handleKeyPress);
        }
        function onPlayerStateChange(event) {
            var ytcurrentTime = player.getCurrentTime();
            if(event.data == YT.PlayerState.ENDED && ytcurrentTime != 0) {
                //とりあえず順々に再生されるように
                pattern = 0;
                playNextVideo(pattern);
            }
        }   
        function loadVideo() {
            if (!playerReady) {
                alert('プレイヤーの準備が完了するまでお待ちください');
                return;
            }
            const url = document.getElementById('video-url').value;
            const videoId = extractVideoId(url);
            if (videoId) player.loadVideoById(videoId);
        }
        
        function extractVideoId(url) {
            if (url.indexOf('youtu.be') !== -1) {
                let editval = url.replace('https://youtu.be/', '');
                return editval.split("?")[0] || '';
            }else if (url.indexOf('live') !== -1) {
                let editval = url.replace('https://www.youtube.com/live/', '');
                editval = editval.replace('https://youtube.com/live/', '');
                return editval.split("?")[0] || '';
            }else if (url.indexOf('shorts') !== -1) {
                let editval = url.replace('https://www.youtube.com/shorts/', '');
                editval = editval.replace('https://youtube.com/shorts/', '');
                return editval.split("?")[0] || '';
            } else {
                const match = url.match(/[?&]v=([^&]+)/);
                return match ? match[1] : null;
            }
        }
        
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        function setCurrenttime(){
            document.getElementById('timehidden').value = player.getCurrentTime();
            document.getElementById('timedisplay').value = formatTime(player.getCurrentTime());
        }
        function saveNote() {
            if (!playerReady) return;
//            const time = document.getElementById('timehidden').value;
            const time = player.getCurrentTime();
            const note = document.getElementById('note').value;
            notes.push({ time, note });
            notes.sort((a, b) => a.time - b.time);
            renderNotes();
        }
        function playNextVideo(i_type) {
            if (i_type == 0) {
                currentIndex++;
                if (currentIndex >= videoIdList.length) {
                currentIndex = 0;
                }
            } else if (i_type == 1) {
                currentIndex--;
                    if (currentIndex < 0) {
                    currentIndex = videoIdList.length - 1;
                    }
            }
            playVideoAtTime(videoIdList,currentIndex);
        }
        function handleKeyPress(event) {
            if (!playerReady) return;
            if(inputForcus) return;
            switch(event.key) {
                case 'k': player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo(); break;
                case 'j': player.seekTo(player.getCurrentTime() - 10, true); break;
                case 'l': player.seekTo(player.getCurrentTime() + 10, true); break;
                case 'ArrowLeft': player.seekTo(player.getCurrentTime() - 5, true); break;
                case 'ArrowRight': player.seekTo(player.getCurrentTime() + 5, true); break;
                case 'u': playNextVideo(1); break;
                case 'i': playNextVideo(0); break;
            }
        }
        function func_title(i_data){
        let imgs = `<img width="80" height="60" src="https://i.ytimg.com/vi/${i_data.videoid}/default.jpg" loading="lazy" class="img_middle">`
        let titles = `<input type="text" value="${i_data.musictitle}" readonly/>`
        let singer = `<input type="text" value="${i_data.singer}" readonly/>`
        let artists = `<input type="text" value="${i_data.artist}" readonly/>`
        let div_info = '<div class="play_column"><div>'+ imgs +'</div>' + '<div class="play_info">'+ titles + artists + singer +'</div></div>'
            return div_info
        }
    let option = {
        ajax: {
            dataSrc: '',
            type: 'GET',
            url: 'https://nijiuta.shop/api/utawaku/',
            data: function(d) {
                d.q = '栞葉るり';
//                d.tags = tags;
//                d.filters = filters;
            }
        },
        columns:[
            {'data':'id'},
            {'data':'musictitle'},
            {'data':null
            ,render:function(data, type, row){
                return func_title(data)
            }}
            ],
        createdRow: function(row, data, dataIndex) {
            // 各 <tr> タグにカスタム属性を追加
            $(row).attr('id', 'row-' + data.id);
            $(row).attr('data-video-id', data.videoid);
            $(row).attr('data-start', data.time_s);
            $(row).attr('data-end', data.time_e);
        },
        language: {
            search: "リスト内検索:",
        },
        scrollY: 500,
        scrollX: false,
        paging: false,
        columnDefs:[{targets: 0 ,visible: false},{targets: 1 ,visible: false}]

    };
    $('#playlist-table').DataTable(option);
    // 再生
function playVideoAtTime(arr_videolist, int_index){
    let singerlist = [];
    let alllist = [];
    const nextRowId = arr_videolist[int_index];
    const nextRow = $(`#${nextRowId}`);
    const nextVideoId = nextRow.attr('data-video-id');
    const startTime = parseInt(nextRow.attr('data-start')) || 0;
    const endTime = parseInt(nextRow.attr('data-end')) || 999999;
    if(nextVideoId){
        player.loadVideoById({
            videoId: nextVideoId,
            startSeconds: startTime,
            endSeconds: endTime
        });
    }
}
$('#config').on('click',function(){
    alert('syori')
})
    </script>
</body>
</html>
